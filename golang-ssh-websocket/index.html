<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>[转]Go语言实现SSH远程终端及WebSocket - geekbyの自留地</title><meta name=author content="JackBai"><meta name=author-link content="https://github.com/jackbai233"><meta name=description content="这篇文章介绍了使用golang实现ssh远程终端."><meta name=keywords content="Golang,WebSocket"><meta itemprop=name content="[转]Go语言实现SSH远程终端及WebSocket"><meta itemprop=description content="这篇文章介绍了使用golang实现ssh远程终端."><meta itemprop=datePublished content="2021-10-24T17:02:53+08:00"><meta itemprop=dateModified content="2021-10-24T17:02:53+08:00"><meta itemprop=wordCount content="4021"><meta itemprop=image content="https://www.geekby.cn/images/avatar.png"><meta itemprop=keywords content="Golang,WebSocket,"><meta property="og:title" content="[转]Go语言实现SSH远程终端及WebSocket"><meta property="og:description" content="这篇文章介绍了使用golang实现ssh远程终端."><meta property="og:type" content="article"><meta property="og:url" content="https://www.geekby.cn/golang-ssh-websocket/"><meta property="og:image" content="https://www.geekby.cn/images/avatar.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-24T17:02:53+08:00"><meta property="article:modified_time" content="2021-10-24T17:02:53+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.geekby.cn/images/avatar.png"><meta name=twitter:title content="[转]Go语言实现SSH远程终端及WebSocket"><meta name=twitter:description content="这篇文章介绍了使用golang实现ssh远程终端."><meta name=application-name content="geekby"><meta name=apple-mobile-web-app-title content="geekby"><meta name=theme-color data-light=#ffffff data-dark=#ffffff content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://www.geekby.cn/golang-ssh-websocket/><link rel=prev href=https://www.geekby.cn/consul-watch-golang/><link rel=next href=https://www.geekby.cn/mysql-ha/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[转]Go语言实现SSH远程终端及WebSocket","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.geekby.cn\/golang-ssh-websocket\/"},"genre":"posts","keywords":"Golang, WebSocket","wordcount":4021,"url":"https:\/\/www.geekby.cn\/golang-ssh-websocket\/","datePublished":"2021-10-24T17:02:53+08:00","dateModified":"2021-10-24T17:02:53+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"JackBai"},"description":"这篇文章介绍了使用golang实现ssh远程终端."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=geekbyの自留地><span class=header-title-text>geekbyの自留地</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/>文章</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/about/>关于</a></li><li class=menu-item><a class=menu-link href=https://github.com/jackbai233 title=Github rel="noopener noreferrer" target=_blank><i class='fab fa-github fa-fw'></i></a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=geekbyの自留地><span class=header-title-text>geekbyの自留地</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/>文章</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/about/>关于</a></li><li class=menu-item><a class=menu-link href=https://github.com/jackbai233 title=Github rel="noopener noreferrer" target=_blank><i class='fab fa-github fa-fw'></i></a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>[转]Go语言实现SSH远程终端及WebSocket</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/jackbai233 title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img loading=lazy src=/images/avatar.png srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x" sizes=auto data-title=JackBai data-alt=JackBai width=192 height=192 class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;JackBai</a></span>
<span class=post-category>收录于 <a href=/categories/%E5%90%8E%E7%AB%AF/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 后端</a></span></div><div class=post-meta-line><span title="发布于 2021-10-24 17:02:53"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2021-10-24>2021-10-24</time></span>&nbsp;<span title="更新于 2021-10-24 17:02:53"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2021-10-24>2021-10-24</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 4021 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 9 分钟</span>&nbsp;<span class=comment-visitors data-flag-title=[转]Go语言实现SSH远程终端及WebSocket>
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span class=artalk-visitor-count data-page-key=/golang-ssh-websocket/>-</span>&nbsp;次阅读
</span>&nbsp;<span class=comment-count data-flag-title=[转]Go语言实现SSH远程终端及WebSocket>
<i class="fa-regular fa-comments fa-fw me-1" aria-hidden=true></i><span class=artalk-comment-count data-page-key=/golang-ssh-websocket/>-</span>&nbsp;条评论
</span>&nbsp;</div></div><div class=featured-image><img loading=lazy src=https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/golang-ssh.2jel1ppf5va0.png srcset="https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/golang-ssh.2jel1ppf5va0.png, https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/golang-ssh.2jel1ppf5va0.png 1.5x, https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/golang-ssh.2jel1ppf5va0.png 2x" sizes=auto data-title=这篇文章介绍了使用golang实现ssh远程终端. data-alt=https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/golang-ssh.2jel1ppf5va0.png style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#使用>使用</a><ul><li><a href=#下载>下载</a></li><li><a href=#使用密码认证连接>使用密码认证连接</a></li></ul></li><li><a href=#websocket简介>WebSocket简介</a><ul><li><a href=#优点>优点</a></li></ul></li><li><a href=#基于web的terminal终端控制台>基于web的Terminal终端控制台</a><ul><li><a href=#实现流程>实现流程</a></li><li><a href=#升级http协议为websocket>升级HTTP协议为WebSocket</a></li><li><a href=#升级协议并获得socket连接>升级协议并获得socket连接</a></li><li><a href=#后台拿到主机信息建立ssh客户端>后台拿到主机信息，建立ssh客户端</a></li><li><a href=#通过ssh客户端创建ssh-channel并请求pty终端请求用户默认会话>通过ssh客户端创建ssh channel，并请求pty终端，请求用户默认会话</a></li><li><a href=#远程主机与浏览器实时数据交换>远程主机与浏览器实时数据交换</a></li><li><a href=#前端>前端</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><p>本文主要介绍了使用golang结合webSocket通信原理来实现远程ssh终端的方法.</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fa-solid fa-lightbulb fa-fw" aria-hidden=true></i>声明<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>本文转载至<a href=https://www.cnblogs.com/you-men/p/13934845.html target=_blank rel="external nofollow noopener noreferrer">https://www.cnblogs.com/you-men/p/13934845.html</a></div></div></div><h2 id=使用>使用</h2><h3 id=下载>下载</h3><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>go get <span class=s2>&#34;github.com/mitchellh/go-homedir&#34;</span>
</span></span><span class=line><span class=cl> go get <span class=s2>&#34;golang.org/x/crypto/ssh&#34;</span></span></span></code></pre></td></tr></table></div></div><h3 id=使用密码认证连接>使用密码认证连接</h3><p>连接包含了认证,可以使用password或者sshkey 两种方式认证,下面采用密码认证方式完成连接</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;golang.org/x/crypto/ssh&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>sshHost</span> <span class=o>:=</span> <span class=s>&#34;39.108.140.0&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>sshUser</span> <span class=o>:=</span> <span class=s>&#34;root&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>sshPasswrod</span> <span class=o>:=</span> <span class=s>&#34;youmen&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>sshType</span> <span class=o>:=</span> <span class=s>&#34;password&#34;</span>  <span class=c1>// password或者key
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//sshKeyPath := &#34;&#34; // ssh id_rsa.id路径
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sshPort</span> <span class=o>:=</span> <span class=mi>22</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建ssh登录配置
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>config</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>ssh</span><span class=p>.</span><span class=nx>ClientConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Timeout</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=c1>// ssh连接time out时间一秒钟,如果ssh验证错误会在一秒钟返回
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>User</span><span class=p>:</span> <span class=nx>sshUser</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>HostKeyCallback</span><span class=p>:</span> <span class=nx>ssh</span><span class=p>.</span><span class=nf>InsecureIgnoreHostKey</span><span class=p>(),</span>  <span class=c1>// 这个可以,但是不够安全
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//HostKeyCallback: hostKeyCallBackFunc(h.Host),
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sshType</span> <span class=o>==</span> <span class=s>&#34;password&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>config</span><span class=p>.</span><span class=nx>Auth</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>ssh</span><span class=p>.</span><span class=nx>AuthMethod</span><span class=p>{</span><span class=nx>ssh</span><span class=p>.</span><span class=nf>Password</span><span class=p>(</span><span class=nx>sshPasswrod</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>//config.Auth = []ssh.AuthMethod(publicKeyAuthFunc(sshKeyPath))
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// dial 获取ssh client
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>addr</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s:%d&#34;</span><span class=p>,</span><span class=nx>sshHost</span><span class=p>,</span><span class=nx>sshPort</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>sshClient</span><span class=p>,</span><span class=nx>err</span> <span class=o>:=</span> <span class=nx>ssh</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span><span class=nx>addr</span><span class=p>,</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;创建ssh client 失败&#34;</span><span class=p>,</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>sshClient</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建ssh-session
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>session</span><span class=p>,</span><span class=nx>err</span> <span class=o>:=</span> <span class=nx>sshClient</span><span class=p>.</span><span class=nf>NewSession</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;创建ssh session失败&#34;</span><span class=p>,</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>session</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 执行远程命令
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>combo</span><span class=p>,</span><span class=nx>err</span> <span class=o>:=</span> <span class=nx>session</span><span class=p>.</span><span class=nf>CombinedOutput</span><span class=p>(</span><span class=s>&#34;whoami; cd /; ls -al;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;远程执行cmd失败&#34;</span><span class=p>,</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;命令输出:&#34;</span><span class=p>,</span><span class=nb>string</span><span class=p>(</span><span class=nx>combo</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//func publicKeyAuthFunc(kPath string) ssh.AuthMethod  {
</span></span></span><span class=line><span class=cl><span class=c1>//	keyPath ,err := homedir.Expand(kPath)
</span></span></span><span class=line><span class=cl><span class=c1>//	if err != nil {
</span></span></span><span class=line><span class=cl><span class=c1>//		log.Fatal(&#34;find key&#39;s home dir failed&#34;,err)
</span></span></span><span class=line><span class=cl><span class=c1>//	}
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>//	key,err := ioutil.ReadFile(keyPath)
</span></span></span><span class=line><span class=cl><span class=c1>//	if err != nil {
</span></span></span><span class=line><span class=cl><span class=c1>//		log.Fatal(&#34;ssh key file read failed&#34;,err)
</span></span></span><span class=line><span class=cl><span class=c1>//	}
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>//	signer,err := ssh.ParsePrivateKey(key)
</span></span></span><span class=line><span class=cl><span class=c1>//	if err != nil {
</span></span></span><span class=line><span class=cl><span class=c1>//		log.Fatal(&#34;ssh key signer failed&#34;,err)
</span></span></span><span class=line><span class=cl><span class=c1>//	}
</span></span></span><span class=line><span class=cl><span class=c1>//	return ssh.PublicKeys(signer)
</span></span></span><span class=line><span class=cl><span class=c1>//}
</span></span></span></code></pre></td></tr></table></div></div><p>代码解读：</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 配置ssh.ClientConfig
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>		建议TimeOut自定义一个比较端的时间
</span></span></span><span class=line><span class=cl><span class=cm>		自定义HostKeyCallback如果像简便就使用ssh.InsecureIgnoreHostKey会带哦,这种方式不是很安全
</span></span></span><span class=line><span class=cl><span class=cm>		publicKeyAuthFunc 如果使用key登录就需要用哪个这个函数量读取id_rsa私钥, 当然也可以自定义这个访问让他支持字符串.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ssh.Dial创建ssh客户端
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>		拼接字符串得到ssh链接地址,同时不要忘记defer client.Close()
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// sshClient.NewSession创建会话
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>		可以自定义stdin,stdout
</span></span></span><span class=line><span class=cl><span class=cm>		可以创建pty
</span></span></span><span class=line><span class=cl><span class=cm>		可以SetEnv
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 执行命令CombinnedOutput run...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>11</span><span class=o>/</span><span class=mo>06</span> <span class=mo>00</span><span class=p>:</span><span class=mo>07</span><span class=p>:</span><span class=mi>31</span> <span class=err>命令输出</span><span class=p>:</span> <span class=nx>root</span>
</span></span><span class=line><span class=cl><span class=nx>total</span> <span class=mi>84</span>
</span></span><span class=line><span class=cl><span class=nx>dr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span> <span class=mi>20</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Sep</span> <span class=mi>28</span> <span class=mi>09</span><span class=p>:</span><span class=mi>38</span> <span class=p>.</span>
</span></span><span class=line><span class=cl><span class=nx>dr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span> <span class=mi>20</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Sep</span> <span class=mi>28</span> <span class=mi>09</span><span class=p>:</span><span class=mi>38</span> <span class=p>..</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=nx>rw</span><span class=o>-</span><span class=nx>r</span><span class=o>--</span><span class=nx>r</span><span class=o>--</span>   <span class=mi>1</span> <span class=nx>root</span>  <span class=nx>root</span>      <span class=mi>0</span> <span class=nx>Aug</span> <span class=mi>18</span>  <span class=mi>2017</span> <span class=p>.</span><span class=nx>autorelabel</span>
</span></span><span class=line><span class=cl><span class=nx>lrwxrwxrwx</span><span class=p>.</span>  <span class=mi>1</span> <span class=nx>root</span>  <span class=nx>root</span>      <span class=mi>7</span> <span class=nx>Aug</span> <span class=mi>18</span>  <span class=mi>2017</span> <span class=nx>bin</span> <span class=o>-</span><span class=p>&gt;</span> <span class=nx>usr</span><span class=o>/</span><span class=nx>bin</span>
</span></span><span class=line><span class=cl><span class=nx>dr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span>  <span class=mi>4</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Sep</span> <span class=mi>12</span>  <span class=mi>2017</span> <span class=nx>boot</span>
</span></span><span class=line><span class=cl><span class=nx>drwxrwxr</span><span class=o>-</span><span class=nx>x</span>   <span class=mi>2</span> <span class=nx>rsync</span> <span class=nx>rsync</span>  <span class=mi>4096</span> <span class=nx>Jul</span> <span class=mi>29</span> <span class=mi>23</span><span class=p>:</span><span class=mi>37</span> <span class=nx>data</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span>  <span class=mi>19</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>2980</span> <span class=nx>Jul</span> <span class=mi>28</span> <span class=mi>13</span><span class=p>:</span><span class=mi>29</span> <span class=nx>dev</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span> <span class=mi>95</span> <span class=nx>root</span>  <span class=nx>root</span>  <span class=mi>12288</span> <span class=nx>Nov</span>  <span class=mi>5</span> <span class=mi>23</span><span class=p>:</span><span class=mi>46</span> <span class=nx>etc</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span>  <span class=mi>5</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Nov</span>  <span class=mi>3</span> <span class=mi>16</span><span class=p>:</span><span class=mi>11</span> <span class=nx>home</span>
</span></span><span class=line><span class=cl><span class=nx>lrwxrwxrwx</span><span class=p>.</span>  <span class=mi>1</span> <span class=nx>root</span>  <span class=nx>root</span>      <span class=mi>7</span> <span class=nx>Aug</span> <span class=mi>18</span>  <span class=mi>2017</span> <span class=nx>lib</span> <span class=o>-</span><span class=p>&gt;</span> <span class=nx>usr</span><span class=o>/</span><span class=nx>lib</span>
</span></span><span class=line><span class=cl><span class=nx>lrwxrwxrwx</span><span class=p>.</span>  <span class=mi>1</span> <span class=nx>root</span>  <span class=nx>root</span>      <span class=mi>9</span> <span class=nx>Aug</span> <span class=mi>18</span>  <span class=mi>2017</span> <span class=nx>lib64</span> <span class=o>-</span><span class=p>&gt;</span> <span class=nx>usr</span><span class=o>/</span><span class=nx>lib64</span>
</span></span><span class=line><span class=cl><span class=nx>drwx</span><span class=o>------</span><span class=p>.</span>  <span class=mi>2</span> <span class=nx>root</span>  <span class=nx>root</span>  <span class=mi>16384</span> <span class=nx>Aug</span> <span class=mi>18</span>  <span class=mi>2017</span> <span class=nx>lost</span><span class=o>+</span><span class=nx>found</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span>  <span class=mi>2</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Nov</span>  <span class=mi>5</span>  <span class=mi>2016</span> <span class=nx>media</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span>  <span class=mi>3</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Jul</span> <span class=mi>28</span> <span class=mi>21</span><span class=p>:</span><span class=mo>01</span> <span class=nx>mnt</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span>   <span class=mi>4</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Sep</span> <span class=mi>28</span> <span class=mi>09</span><span class=p>:</span><span class=mi>38</span> <span class=nx>nginx_test</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span>  <span class=mi>8</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Nov</span>  <span class=mi>3</span> <span class=mi>16</span><span class=p>:</span><span class=mi>10</span> <span class=nx>opt</span>
</span></span><span class=line><span class=cl><span class=nx>dr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span>  <span class=mi>87</span> <span class=nx>root</span>  <span class=nx>root</span>      <span class=mi>0</span> <span class=nx>Jul</span> <span class=mi>28</span> <span class=mi>13</span><span class=p>:</span><span class=mi>26</span> <span class=nx>proc</span>
</span></span><span class=line><span class=cl><span class=nx>dr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=o>---</span><span class=p>.</span> <span class=mi>18</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Nov</span>  <span class=mi>4</span> <span class=mo>00</span><span class=p>:</span><span class=mi>38</span> <span class=nx>root</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span>  <span class=mi>27</span> <span class=nx>root</span>  <span class=nx>root</span>    <span class=mi>860</span> <span class=nx>Nov</span>  <span class=mi>4</span> <span class=mi>21</span><span class=p>:</span><span class=mi>57</span> <span class=nx>run</span>
</span></span><span class=line><span class=cl><span class=nx>lrwxrwxrwx</span><span class=p>.</span>  <span class=mi>1</span> <span class=nx>root</span>  <span class=nx>root</span>      <span class=mi>8</span> <span class=nx>Aug</span> <span class=mi>18</span>  <span class=mi>2017</span> <span class=nx>sbin</span> <span class=o>-</span><span class=p>&gt;</span> <span class=nx>usr</span><span class=o>/</span><span class=nx>sbin</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span>  <span class=mi>2</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Nov</span>  <span class=mi>5</span>  <span class=mi>2016</span> <span class=nx>srv</span>
</span></span><span class=line><span class=cl><span class=nx>dr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span>  <span class=mi>13</span> <span class=nx>root</span>  <span class=nx>root</span>      <span class=mi>0</span> <span class=nx>Jul</span> <span class=mi>28</span> <span class=mi>21</span><span class=p>:</span><span class=mi>26</span> <span class=nx>sys</span>
</span></span><span class=line><span class=cl><span class=nx>drwxrwxrwt</span><span class=p>.</span>  <span class=mi>8</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Nov</span>  <span class=mi>5</span> <span class=mo>03</span><span class=p>:</span><span class=mi>09</span> <span class=nx>tmp</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span> <span class=mi>13</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Aug</span> <span class=mi>18</span>  <span class=mi>2017</span> <span class=nx>usr</span>
</span></span><span class=line><span class=cl><span class=nx>drwxr</span><span class=o>-</span><span class=nx>xr</span><span class=o>-</span><span class=nx>x</span><span class=p>.</span> <span class=mi>21</span> <span class=nx>root</span>  <span class=nx>root</span>   <span class=mi>4096</span> <span class=nx>Nov</span>  <span class=mi>3</span> <span class=mi>16</span><span class=p>:</span><span class=mi>10</span> <span class=kd>var</span></span></span></code></pre></td></tr></table></div></div><p>以上内容摘自：<a href=https://mojotv.cn/2019/05/22/golang-ssh-session target=_blank rel="external nofollow noopener noreferrer">https://mojotv.cn/2019/05/22/golang-ssh-session</a></p><h2 id=websocket简介>WebSocket简介</h2><p>HTML5开始提供的一种浏览器与服务器进行双工通讯的网络技术,属于应用层协议,它基于TCP传输协议,并复用HTTP的握手通道:</p><p>对大部分web开发者来说,上面描述有点枯燥,只需要几下以下三点</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl>		1. WebSocket可以在浏览器里使用
</span></span><span class=line><span class=cl>		2. 支持双向通信
</span></span><span class=line><span class=cl>		3. 使用很简单
</span></span><span class=line><span class=cl>*/</span></span></code></pre></td></tr></table></div></div><h3 id=优点>优点</h3><p>对比HTTP协议的话,概括的说就是: 支持双向通信,更灵活,更高效,可扩展性更好</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl>		1. 支持双向通信,实时性更强
</span></span><span class=line><span class=cl>		2. 更好的二进制支持
</span></span><span class=line><span class=cl>		3. 较少的控制开销,连接创建后,客户端和服务端进行数据交换时,协议控制的数据包头部较小,在不包含头部的情况下,
</span></span><span class=line><span class=cl>				服务端到客户端的包头只有2-10字节(取决于数据包长度), 客户端到服务端的话,需要加上额外4字节的掩码,
</span></span><span class=line><span class=cl>				而HTTP每次同年高新都需要携带完整的头部
</span></span><span class=line><span class=cl>		4. 支持扩展,ws协议定义了扩展, 用户可以扩展协议, 或者实现自定义的子协议
</span></span><span class=line><span class=cl>*/</span></span></code></pre></td></tr></table></div></div><h2 id=基于web的terminal终端控制台>基于web的Terminal终端控制台</h2><p>完成这样一个Web Terminal的目的主要是解决几个问题:</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl>		1. 一定程度上取代xshell，secureRT，putty等ssh终端
</span></span><span class=line><span class=cl>		2. 可以方便身份认证, 访问控制
</span></span><span class=line><span class=cl>		3. 方便使用, 不受电脑环境的影响
</span></span><span class=line><span class=cl>*/</span></span></code></pre></td></tr></table></div></div><p>要实现远程登录的功能,其数据流向大概为</p><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl>		浏览器 &lt;--&gt;  WebSocket  &lt;---&gt; SSH &lt;---&gt; Linux OS
</span></span><span class=line><span class=cl>*/</span></span></code></pre></td></tr></table></div></div><h3 id=实现流程>实现流程</h3><ul><li><ol><li>浏览器将主机的信息(ip, 用户名, 密码, 请求的终端大小等)进行加密, 传给后台, 并通过HTTP请求与后台协商升级协议. 协议升级完成后, 后续的数据交换则遵照web Socket的协议.</li></ol></li><li><ol start=2><li>后台将HTTP请求升级为web Socket协议, 得到一个和浏览器数据交换的连接通道</li></ol></li><li><ol start=3><li>后台将数据进行解密拿到主机信息, 创建一个SSH 客户端, 与远程主机的SSH 服务端协商加密, 互相认证, 然后建立一个SSH Channel</li></ol></li><li><ol start=4><li>后台和远程主机有了通讯的信道, 然后后台将终端的大小等信息通过SSH Channel请求远程主机创建一个 pty(伪终端), 并请求启动当前用户的默认 shell</li></ol></li><li><ol start=5><li>后台通过 Socket连接通道拿到用户输入, 再通过SSH Channel将输入传给pty, pty将这些数据交给远程主机处理后按照前面指定的终端标准输出到SSH Channel中, 同时键盘输入也会发送给SSH Channel</li></ol></li><li><ol start=6><li>后台从SSH Channel中拿到按照终端大小的标准输出后又通过Socket连接将输出返回给浏览器, 由此变实现了Web Terminal</li></ol></li></ul><p><img loading=lazy src=https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/image.2qsqdsa5h4o0.png srcset="https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/image.2qsqdsa5h4o0.png, https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/image.2qsqdsa5h4o0.png 1.5x, https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/image.2qsqdsa5h4o0.png 2x" sizes=auto data-title=image data-alt=image style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><img loading=lazy src=https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/image.54fxpcesfi00.png srcset="https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/image.54fxpcesfi00.png, https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/image.54fxpcesfi00.png 1.5x, https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/image.54fxpcesfi00.png 2x" sizes=auto data-title=image data-alt=image style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>按照上面的使用流程基于代码解释如何实现</p><h3 id=升级http协议为websocket>升级HTTP协议为WebSocket</h3><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>upgrader</span> <span class=p>=</span> <span class=nx>websocket</span><span class=p>.</span><span class=nx>Upgrader</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ReadBufferSize</span><span class=p>:</span>  <span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>WriteBufferSize</span><span class=p>:</span> <span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>CheckOrigin</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=升级协议并获得socket连接>升级协议并获得socket连接</h3><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>upgrader</span><span class=p>.</span><span class=nf>Upgrade</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>conn就是socket连接通道, 接下来后台和浏览器之间的通讯都将基于这个通道</p><h3 id=后台拿到主机信息建立ssh客户端>后台拿到主机信息，建立ssh客户端</h3><p>ssh客户端结构体</p><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SSHClient</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Username</span>  <span class=kt>string</span> <span class=s>`json:&#34;username&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Password</span>  <span class=kt>string</span> <span class=s>`json:&#34;password&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>IpAddress</span> <span class=kt>string</span> <span class=s>`json:&#34;ipaddress&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Port</span>      <span class=kt>int</span>    <span class=s>`json:&#34;port&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Session</span>   <span class=o>*</span><span class=nx>ssh</span><span class=p>.</span><span class=nx>Session</span>
</span></span><span class=line><span class=cl>	<span class=nx>Client</span>    <span class=o>*</span><span class=nx>ssh</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl>	<span class=nx>channel</span>   <span class=nx>ssh</span><span class=p>.</span><span class=nx>Channel</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//创建新的ssh客户端时, 默认用户名为root, 端口为22
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewSSHClient</span><span class=p>()</span> <span class=nx>SSHClient</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>SSHClient</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span><span class=p>.</span><span class=nx>Username</span> <span class=p>=</span> <span class=s>&#34;root&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span><span class=p>.</span><span class=nx>Port</span> <span class=p>=</span> <span class=mi>22</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>client</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>初始化的时候我们只有主机的信息, 而Session, client, channel都是空的, 现在先生成真正的client:</p><div class=highlight id=id-11><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>SSHClient</span><span class=p>)</span> <span class=nf>GenerateClient</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>auth</span>         <span class=p>[]</span><span class=nx>ssh</span><span class=p>.</span><span class=nx>AuthMethod</span>
</span></span><span class=line><span class=cl>		<span class=nx>addr</span>         <span class=kt>string</span>
</span></span><span class=line><span class=cl>		<span class=nx>clientConfig</span> <span class=o>*</span><span class=nx>ssh</span><span class=p>.</span><span class=nx>ClientConfig</span>
</span></span><span class=line><span class=cl>		<span class=nx>client</span>       <span class=o>*</span><span class=nx>ssh</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl>		<span class=nx>config</span>       <span class=nx>ssh</span><span class=p>.</span><span class=nx>Config</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span>          <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>auth</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>ssh</span><span class=p>.</span><span class=nx>AuthMethod</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>auth</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>auth</span><span class=p>,</span> <span class=nx>ssh</span><span class=p>.</span><span class=nf>Password</span><span class=p>(</span><span class=nx>this</span><span class=p>.</span><span class=nx>Password</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span> <span class=p>=</span> <span class=nx>ssh</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Ciphers</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;aes128-ctr&#34;</span><span class=p>,</span> <span class=s>&#34;aes192-ctr&#34;</span><span class=p>,</span> <span class=s>&#34;aes256-ctr&#34;</span><span class=p>,</span> <span class=s>&#34;aes128-gcm@openssh.com&#34;</span><span class=p>,</span> <span class=s>&#34;arcfour256&#34;</span><span class=p>,</span> <span class=s>&#34;arcfour128&#34;</span><span class=p>,</span> <span class=s>&#34;aes128-cbc&#34;</span><span class=p>,</span> <span class=s>&#34;3des-cbc&#34;</span><span class=p>,</span> <span class=s>&#34;aes192-cbc&#34;</span><span class=p>,</span> <span class=s>&#34;aes256-cbc&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>clientConfig</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>ssh</span><span class=p>.</span><span class=nx>ClientConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>User</span><span class=p>:</span>    <span class=nx>this</span><span class=p>.</span><span class=nx>Username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Auth</span><span class=p>:</span>    <span class=nx>auth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Timeout</span><span class=p>:</span> <span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Config</span><span class=p>:</span>  <span class=nx>config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>HostKeyCallback</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>hostname</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>remote</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Addr</span><span class=p>,</span> <span class=nx>key</span> <span class=nx>ssh</span><span class=p>.</span><span class=nx>PublicKey</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>addr</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s:%d&#34;</span><span class=p>,</span> <span class=nx>this</span><span class=p>.</span><span class=nx>IpAddress</span><span class=p>,</span> <span class=nx>this</span><span class=p>.</span><span class=nx>Port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>ssh</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>addr</span><span class=p>,</span> <span class=nx>clientConfig</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>this</span><span class=p>.</span><span class=nx>Client</span> <span class=p>=</span> <span class=nx>client</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>ssh.Dial(“tcp”, addr, clientConfig)创建连接并返回客户端, 如果主机信息不对或其它问题这里将直接失败</p><h3 id=通过ssh客户端创建ssh-channel并请求pty终端请求用户默认会话>通过ssh客户端创建ssh channel，并请求pty终端，请求用户默认会话</h3><p>如果主机信息验证通过, 可以通过ssh client创建一个通道:</p><div class=highlight id=id-12><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>channel</span><span class=p>,</span> <span class=nx>inRequests</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>this</span><span class=p>.</span><span class=nx>Client</span><span class=p>.</span><span class=nf>OpenChannel</span><span class=p>(</span><span class=s>&#34;session&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>this</span><span class=p>.</span><span class=nx>channel</span> <span class=p>=</span> <span class=nx>channel</span></span></span></code></pre></td></tr></table></div></div><p>ssh通道创建完成后, 请求一个标准输出的终端, 并开启用户的默认shell:</p><div class=highlight id=id-13><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ok</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>channel</span><span class=p>.</span><span class=nf>SendRequest</span><span class=p>(</span><span class=s>&#34;pty-req&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>ssh</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>req</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=o>||</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>ok</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>channel</span><span class=p>.</span><span class=nf>SendRequest</span><span class=p>(</span><span class=s>&#34;shell&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=o>||</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=远程主机与浏览器实时数据交换>远程主机与浏览器实时数据交换</h3><p>现在为止建立了两个通道, 一个是websocket, 一个是ssh channel, 后台将起两个主要的协程, 一个不停的从websocket通道里读取用户的输入, 并通过ssh channel传给远程主机:</p><div class=highlight id=id-14><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//这里第一个协程获取用户的输入
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// p为用户输入
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>_</span><span class=p>,</span> <span class=nx>p</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>ReadMessage</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>this</span><span class=p>.</span><span class=nx>channel</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}()</span></span></span></code></pre></td></tr></table></div></div><p>第二个主协程将远程主机的数据传递给浏览器, 在这个协程里还将起一个协程, 不断获取ssh channel里的数据并传给后台内部创建的一个通道, 主协程则有一个死循环, 每隔一段时间从内部通道里读取数据, 并将其通过websocket传给浏览器, 所以数据传输并不是真正实时的,而是有一个间隔在, 我写的默认为100微秒, 这样基本感受不到延迟, 而且减少了消耗, 有时浏览器输入一个命令获取大量数据时, 会感觉数据出现会一顿一顿的便是因为设置了一个间隔:</p><div class=highlight id=id-15><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//第二个协程将远程主机的返回结果返回给用户
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>br</span> <span class=o>:=</span> <span class=nx>bufio</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>(</span><span class=nx>this</span><span class=p>.</span><span class=nx>channel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>buf</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>t</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Microsecond</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 构建一个信道, 一端将数据远程主机的数据写入, 一段读取数据写入ws
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>rune</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 另起一个协程, 一个死循环不断的读取ssh channel的数据, 并传给r信道直到连接断开
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=nx>this</span><span class=p>.</span><span class=nx>Client</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=nx>this</span><span class=p>.</span><span class=nx>Session</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>x</span><span class=p>,</span> <span class=nx>size</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>br</span><span class=p>.</span><span class=nf>ReadRune</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>ws</span><span class=p>.</span><span class=nf>WriteMessage</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;\033[31m已经关闭连接!\033[0m&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=nx>ws</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>size</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>r</span> <span class=o>&lt;-</span> <span class=nx>x</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 主循环
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 每隔100微秒, 只要buf的长度不为0就将数据写入ws, 并重置时间和buf
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>WriteMessage</span><span class=p>(</span><span class=nx>websocket</span><span class=p>.</span><span class=nx>TextMessage</span><span class=p>,</span> <span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>buf</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>t</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Microsecond</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 前面已经将ssh channel里读取的数据写入创建的通道r, 这里读取数据, 不断增加buf的长度, 在设定的 100 microsecond后由上面判定长度是否返送数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=nx>d</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>r</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>d</span> <span class=o>!=</span> <span class=nx>utf8</span><span class=p>.</span><span class=nx>RuneError</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>p</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>utf8</span><span class=p>.</span><span class=nf>RuneLen</span><span class=p>(</span><span class=nx>d</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=nx>utf8</span><span class=p>.</span><span class=nf>EncodeRune</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=nx>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>buf</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>buf</span><span class=p>,</span> <span class=nx>p</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>buf</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>buf</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;@&#34;</span><span class=p>)</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}()</span></span></span></code></pre></td></tr></table></div></div><p>web terminal的后台建好了</p><h3 id=前端>前端</h3><p>前端我选择用了vue框架(其实这么小的项目完全不用vue), 终端工具用的是xterm, vscode内置的终端也是采用的xterm.这里贴一段关键代码, <a href=https://github.com/chengjoey/web-terminal-client target=_blank rel="external nofollow noopener noreferrer">前端项目地址</a></p><div class=highlight id=id-16><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>mounted</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>containerWidth</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>screen</span><span class=p>.</span><span class=nx>height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>containerHeight</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>screen</span><span class=p>.</span><span class=nx>width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>cols</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>((</span><span class=nx>containerWidth</span> <span class=o>-</span> <span class=mi>30</span><span class=p>)</span> <span class=o>/</span> <span class=mi>9</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>rows</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>innerHeight</span><span class=o>/</span><span class=mi>17</span><span class=p>)</span> <span class=o>-</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=kc>undefined</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=p>(</span><span class=nx>location</span><span class=p>.</span><span class=nx>protocol</span> <span class=o>===</span> <span class=s2>&#34;http:&#34;</span> <span class=o>?</span> <span class=s2>&#34;ws&#34;</span> <span class=o>:</span> <span class=s2>&#34;wss&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;://&#34;</span> <span class=o>+</span> <span class=nx>location</span><span class=p>.</span><span class=nx>hostname</span> <span class=o>+</span> <span class=s2>&#34;:5001&#34;</span> <span class=o>+</span> <span class=s2>&#34;/ws&#34;</span><span class=o>+</span> <span class=s2>&#34;?&#34;</span> <span class=o>+</span> <span class=s2>&#34;msg=&#34;</span> <span class=o>+</span> <span class=k>this</span><span class=p>.</span><span class=nx>msg</span> <span class=o>+</span> <span class=s2>&#34;&amp;rows=&#34;</span> <span class=o>+</span> <span class=nx>rows</span> <span class=o>+</span> <span class=s2>&#34;&amp;cols=&#34;</span> <span class=o>+</span> <span class=nx>cols</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=p>(</span><span class=nx>location</span><span class=p>.</span><span class=nx>protocol</span> <span class=o>===</span> <span class=s2>&#34;http:&#34;</span> <span class=o>?</span> <span class=s2>&#34;ws&#34;</span> <span class=o>:</span> <span class=s2>&#34;wss&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;://&#34;</span> <span class=o>+</span> <span class=nx>location</span><span class=p>.</span><span class=nx>hostname</span> <span class=o>+</span> <span class=s2>&#34;:5001&#34;</span> <span class=o>+</span> <span class=s2>&#34;/ws&#34;</span><span class=o>+</span> <span class=s2>&#34;?&#34;</span> <span class=o>+</span> <span class=s2>&#34;msg=&#34;</span> <span class=o>+</span> <span class=k>this</span><span class=p>.</span><span class=nx>msg</span> <span class=o>+</span> <span class=s2>&#34;&amp;rows=&#34;</span> <span class=o>+</span> <span class=nx>rows</span> <span class=o>+</span> <span class=s2>&#34;&amp;cols=&#34;</span> <span class=o>+</span> <span class=nx>cols</span> <span class=o>+</span> <span class=s2>&#34;&amp;username=&#34;</span> <span class=o>+</span> <span class=k>this</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&amp;password=&#34;</span> <span class=o>+</span> <span class=k>this</span><span class=p>.</span><span class=nx>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>terminalContainer</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;terminal&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>term</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Terminal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>term</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=nx>terminalContainer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// open websocket
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>terminalSocket</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebSocket</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>terminalSocket</span><span class=p>.</span><span class=nx>onopen</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>runRealTerminal</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>terminalSocket</span><span class=p>.</span><span class=nx>onclose</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>closeRealTerminal</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>terminalSocket</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>errorRealTerminal</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>term</span><span class=p>.</span><span class=nx>attach</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>terminalSocket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>term</span><span class=p>.</span><span class=nx>_initialized</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;mounted is going on&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden=true></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>在使用xterm时需要将其css文件也导入，不然会有显示问题</div></div></div><h2 id=参考>参考</h2><ol><li><a href=https://github.com/piupuer/gin-web/blob/dev/api/v1/sys_machine_ws.go target=_blank rel="external nofollow noopener noreferrer">gin-web-machine-ws</a></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2021-10-24 17:02:53">更新于 2021-10-24&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://www.geekby.cn/golang-ssh-websocket/ data-title=[转]Go语言实现SSH远程终端及WebSocket data-via=@geekby1024 data-hashtags=Golang,WebSocket><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://www.geekby.cn/golang-ssh-websocket/ data-title=[转]Go语言实现SSH远程终端及WebSocket data-image=https://cdn.staticaly.com/gh/jackbai233/image-hosting@master/20211024/golang-ssh.2jel1ppf5va0.png data-ralateuid=u/5101801783><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/golang/ class=post-tag>Golang</a><a href=/tags/websocket/ class=post-tag>WebSocket</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/consul-watch-golang/ class=post-nav-item rel=prev title=使用Consul的watch机制监控服务的变化><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>使用Consul的watch机制监控服务的变化</a>
<a href=/mysql-ha/ class=post-nav-item rel=next title="MySQL 高可用方案研究">MySQL 高可用方案研究<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-reward><div class=comment>Buy me a coffee</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward>赞赏</label><div class=reward-ways data-mode=fixed><div><img loading=lazy src=/images/alipay.jpg srcset="/images/alipay.jpg, /images/alipay.jpg 1.5x, /images/alipay.jpg 2x" sizes=auto data-title="JackBai 支付宝" data-alt="JackBai 支付宝" width=249 height=300 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span data-animation>支付宝</span></div><div><img loading=lazy src=/images/wechatpay.jpg srcset="/images/wechatpay.jpg, /images/wechatpay.jpg 1.5x, /images/wechatpay.jpg 2x" sizes=auto data-title="JackBai 微信" data-alt="JackBai 微信" width=278 height=300 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span data-animation>微信</span></div></div></div><div id=comments><div id=artalk class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://github.com/ArtalkJS/Artalk rel="external nofollow noopener noreferrer">Artalk</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.115.3">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2020 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/jackbai233 target=_blank rel="external nofollow noopener noreferrer">JackBai</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div><div class="footer-line beian"><span class="icp footer-divider"><a href=https://beian.miit.gov.cn/ target=_blank>陕ICP备2020013535号-2</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/artalk/Artalk.min.css><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/artalk/Artalk.js></script><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:20},comment:{artalk:{countEl:"artalk-comment-count",editorTravel:!0,el:"#artalk",flatMode:"auto",gravatar:{default:"",mirror:"www.gravatar.com"},locale:"zh-CN",nestMax:2,nestSort:"DATE_ASC",pageKey:"https://www.geekby.cn/golang-ssh-websocket/",pageTitle:"[转]Go语言实现SSH远程终端及WebSocket",pvEl:"artalk-visitor-count",server:"https://www.geekby.cn/artalk",site:"geekbyの自留地"},enable:!0,expired:!1},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1}}</script><script src=/js/theme.min.js defer></script></body></html>